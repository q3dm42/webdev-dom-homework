<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <!-- рендеринг комментариев из JS -->
    <ul class="comments"></ul>

    <!-- форма ввода нового комментария -->
    <div class="add-form">

      <!-- имя -->
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <!-- поле ввода комментария -->
      <textarea class="add-form-text" placeholder="Введите ваш комментарий" rows="4"></textarea>
      <!-- область отправки комментария -->
      <div class="add-form-row">
        <button class="add-form-button" disabled>Написать</button>
      </div>

    </div>

  </div>
</body>

<script>

  // сохранение ссылки API в переменной
  const apiUrl = 'https://wedev-api.sky.pro/api/v1/sergei-smirnov/comments';

  document.addEventListener('DOMContentLoaded', () => {

    // получение данных инпута из формы
    const addButton = document.querySelector('.add-form-button');
    const nameInput = document.querySelector('.add-form-name');
    const textInput = document.querySelector('.add-form-text');
    nameInput.value = '';
    textInput.value = '';

    // массив для хранения комментариев и локальной работы лайков
    let comments = [];


    // получаем комментарии с сервера
    function fetchComments() {
      fetch(apiUrl, { method: 'GET' })
        .then(response => {
          if (!response.ok) {
            throw new Error('Ошибка при загрузке комментариев');
          }
          return response.json();
        })
        .then(data => {
          // обрабатываем данные и преобразуем их в нужный формат
          comments = data.comments.map((comment) => ({
            name: comment.author.name,
            date: new Date(comment.date).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }),
            text: comment.text,
            likes: comment.likes,
            liked: comment.isLiked,
            id: comment.id,
          }));

          // рендерим комментарии
          renderComments(comments);
        })
        .catch(error => {
          console.error(error);
        });
    }

    // отправка нового комментария на сервер
    function postComment(name, text) {
      fetch(apiUrl, {
        method: 'POST',
        body: JSON.stringify({ name, text })
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
              throw new Error('Ошибка при добавлении комментария: ' + JSON.stringify(errorData));
            });
          }
          // если успешно добавлено, то загружаем обновленный список комментариев
          fetchComments();
        })
        .catch(error => {
          console.error('Ошибка при добавлении комментария:', error);
        });
    }

    // рендеринг комментариев
    function renderComments(commentsArray) {
      const commentsList = document.querySelector('.comments');
      commentsList.innerHTML = '';

      commentsArray.forEach((comment, index) => {
        const li = document.createElement('li');
        li.classList.add('comment');
        li.innerHTML = `
                    <div class="comment-header">
                        <div>${comment.name}</div>
                        <div>${comment.date}</div>
                    </div>
                    <div class="comment-body">
                        <div class="comment-text">${comment.text}</div>
                    </div>
                    <div class="comment-footer">
                        <div class="likes">
                            <span class="likes-counter">${comment.likes}</span>
                            <button class="like-button${comment.liked ? ' -active-like' : ''}" data-index="${index}"></button>
                        </div>
                    </div>
                `;
        commentsList.appendChild(li);

        // обработчик события для кнопки лайка
        const likeButton = li.querySelector('.like-button');
        likeButton.addEventListener('click', () => {
          toggleLike(index);
        });
      });
    }

    // функция для переключения лайка локально
    function toggleLike(index) {
      const comment = comments[index];
      if (!comment.liked) {
        comment.likes++;
      } else {
        comment.likes--;
      }
      comment.liked = !comment.liked;

      // обновляем комментарии
      renderComments(comments);
    }

    // замена кода в полях ввода на символы
    function checkSubmit() {
      const inputAddNameForm = document.querySelector('.add-form-name');
      const areaAddFormRow = document.querySelector('.add-form-text');
      const inputValue = inputAddNameForm.value
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;');

      const areaFormValue = areaAddFormRow.value
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll('QUOTE_BEGIN', "<div class='quote'>")
        .replaceAll('QUOTE_END', '</div>')
        .replaceAll('\n', '<br>');

      
      if (inputValue !== '' && areaFormValue !== '') {
        postComment(inputValue, areaFormValue);
      }



    }

    // функция для проверки заполненности полей ввода
    function checkFields() {
      const name = nameInput.value.trim();
      const text = textInput.value.trim();
      return name !== '' && text !== '';

    }

    // функция для обновления состояния кнопки отправки
    function updateButtonState() {
      addButton.disabled = !checkFields();
    }

    // обработчики событий для ввода имени и текста комментария
    nameInput.addEventListener('input', updateButtonState);
    textInput.addEventListener('input', updateButtonState);

    // обработчик события для кнопки отправки комментария
    addButton.addEventListener('click', () => {
      checkSubmit();
      // очищаем поля ввода после отправки
      nameInput.value = '';
      textInput.value = '';
      updateButtonState();
    });

    // обработчик события для отправки комментария по клавишам Shift+Enter
    textInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter' && event.shiftKey) {
        checkSubmit();
        // очищаем поля ввода после отправки
        nameInput.value = '';
        textInput.value = '';
        updateButtonState();
        event.preventDefault();
      }
    });

    // загружаем комментарии при загрузке страницы
    fetchComments();
  });
</script>

</html>