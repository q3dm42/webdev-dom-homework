<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">

    <!-- рендеринг комментариев из JS -->
    <ul class="comments"></ul>

    <!-- форма ввода нового комментария -->
    <!-- имя -->
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <!-- комментарий -->
      <textarea class="add-form-text" placeholder="Введите ваш комментарий" rows="4"></textarea>
      <!-- область кнопки -->
      <div class="add-form-row">
        <button class="add-form-button">Написать</button>
      </div>
    </div>

  </div>
</body>

<script>

  //создание исходного массива
  const comments = [
    {
      name: 'Глеб Фокин',
      date: '12.02.22 12:18',
      text: 'Это будет первый комментарий на этой странице',
      likes: 3,
      liked: false
    },
    {
      name: 'Варвара Н.',
      date: '13.02.22 19:22',
      text: 'Мне нравится как оформлена эта страница! ❤',
      likes: 75,
      liked: false
    }
  ];


  document.addEventListener('DOMContentLoaded', () => {

    //получение данных инпута из формы
    const addButton = document.querySelector('.add-form-button');
    const nameInput = document.querySelector('.add-form-name');
    const textInput = document.querySelector('.add-form-text');

    //рендеринг комментариев
    function renderComments(commentsArray) {
      const commentsList = document.querySelector('.comments');
      commentsList.innerHTML = '';

      commentsArray.forEach((comment, index) => {
        const li = document.createElement('li');
        li.classList.add('comment');
        li.innerHTML = `
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${comment.text}</div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button class="like-button${comment.liked ? ' -active-like' : ''}" data-index="${index}"></button>
            </div>
          </div>
        `;
        commentsList.appendChild(li);
        const likeButton = li.querySelector('.like-button');
        likeButton.addEventListener('click', () => {
          toggleLike(index);
        });
      });
    }
    renderComments(comments);

    //функция проверки заполненности полей
    function checkFields() {
      const name = nameInput.value.trim();
      const text = textInput.value.trim();
      return name !== '' && text !== '';
    }

    //функция обновления активности кнопки
    function updateButtonState() {
      addButton.disabled = !checkFields();
    }

    //обновление активности кнопки при вводе
    nameInput.addEventListener('input', updateButtonState);
    textInput.addEventListener('input', updateButtonState);

    //обработчик клика на кнопку "Написать"
    addButton.addEventListener('click', () => {
      checkSubmit();
    });

    //обработчик нажатия Enter в текстовом поле
    textInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter' && event.shiftKey) {
        checkSubmit();
        event.preventDefault();
      }
    });


    //функция переключения лайка
    function toggleLike(index) {
      const comment = comments[index];
      if (!comment.liked) {
        comment.likes++;
      } else {
        comment.likes--;
      }
      comment.liked = !comment.liked;
      renderComments(comments);
    }

    //получение текущей даты и времени
    function getCurrentDate() {
      const now = new Date();
      const date = now.toLocaleDateString('ru-RU');
      const time = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      return `${date} ${time}`;
    }

    //функция обработки при нажатии на кнопку "написать"
    function checkSubmit() {
      const inputAddNameForm = document.querySelector('.add-form-name');
      const areaAddFormRow = document.querySelector('.add-form-text');
      const inputValue = inputAddNameForm.value
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;');

      const areaFormValue = areaAddFormRow.value
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll('QUOTE_BEGIN', "<div class='quote'>")
        .replaceAll('QUOTE_END', '</div>')
        .replaceAll('\n', '<br>');

      if (inputValue !== '' && areaFormValue !== '') {
        addComment(inputValue, areaFormValue);
      }

      //проверка и удаления пробелов
      function addComment(name, text) {
        const newComment = {
          name: name,
          date: getCurrentDate(),
          text: text,
          likes: 0,
          liked: false
        };
        comments.push(newComment);
        renderComments(comments);
        inputAddNameForm.value = '';
        areaAddFormRow.value = '';
      }
    }



    //функция цитаты
    function toQuote(commentText, commentAuthor) {

      //получаем поле ввода для имени и комментария
      const nameInput = document.querySelector('.add-form-name');
      const textInput = document.querySelector('.add-form-text');


      //заменяем символы новой строки на теги <br> в тексте комментария
      const formattedCommentText = commentText.replace(/\n/g, '<br>');



      //собираем текст цитаты с использованием тегов и переносов строки
      const quotedComment = `QUOTE_BEGIN${commentAuthor}: ${formattedCommentText}<br>QUOTE_END`;
      //записываем текущее значение текстового поля в currentValue
      const currentValue = textInput.value;


      //добавляем цитату к текущему значению текстового поля
      const newValue = currentValue ? currentValue + quotedComment : quotedComment;
      //заполняем поле ввода новым значением
      textInput.value = newValue;

      //устанавливаем фокус на поле ввода для комментария
      textInput.focus();

    }




    //сохраняем все тексты комментариев
    const commentTexts = document.querySelectorAll('.comment-text');
    //для каждого текста комментария добавляем обработчик клика
    commentTexts.forEach((commentText) => {
      //получаем автора комментария из родительского элемента
      const commentAuthor = commentText.parentElement.parentElement.querySelector('.comment-header div').textContent;
      commentText.addEventListener('click', () => {
        toQuote(commentText.textContent, commentAuthor);
      });
    });

  });
</script>

</html>